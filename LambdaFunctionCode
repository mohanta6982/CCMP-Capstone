import os
import boto3
from io import BytesIO
from PIL import Image

s3 = boto3.client('s3')
DEST_BUCKET = os.environ.get('DEST_BUCKET')

def resize_image(image_bytes, max_size=128):
    with Image.open(BytesIO(image_bytes)) as img:
        img.thumbnail((max_size, max_size))
        out = BytesIO()
        img_format = img.format if img.format else 'PNG'
        img.save(out, format=img_format)
        out.seek(0)
        return out, img_format.lower()

def lambda_handler(event, context):
    try:
        if 'bucket' in event and 'key' in event:
            bucket = event['bucket']
            key = event['key']
        else:
            record = event['Records'][0]
            bucket = record['s3']['bucket']['name']
            key = record['s3']['object']['key']

        obj = s3.get_object(Bucket=bucket, Key=key)
        data = obj['Body'].read()

        resized_io, fmt = resize_image(data, max_size=128)

        dest_key = f"thumbs/{os.path.basename(key)}"
        s3.put_object(
            Bucket=DEST_BUCKET,
            Key=dest_key,
            Body=resized_io.getvalue(),
            ContentType=f"image/{fmt}"
        )

        return {
            "success": True,
            "resized_key": dest_key,
            "source_bucket": bucket,
            "source_key": key
        }

    except Exception as e:
        return {"success": False, "error": str(e)}
